<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>かわいいスマホレジ</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts for a cute, rounded font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png">
  <meta name="theme-color" content="#FFF1F2">

  <style>
    /* Apply the custom font */
    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
    }
    /* Simple fade-in animation for pages and modals */
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    /* Hide scrollbar */
    ::-webkit-scrollbar {
      display: none;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body class="bg-pink-50">

  <!-- Main Container -->
  <div class="container mx-auto max-w-lg p-4 min-h-screen">
    
    <!-- Page 1: Main Register -->
    <div id="page1" class="fade-in">
      <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-pink-500">スマホレジ</h1>
      </header>
      
      <!-- Mode Selection Card -->
      <div class="bg-white rounded-2xl shadow-lg p-5 mb-6">
        <h2 class="text-lg font-bold text-gray-700 mb-3">業態選択</h2>
        <div id="modeSelection" class="flex flex-col sm:flex-row gap-3">
          <button onclick="selectMode('counter', this)" class="mode-btn flex-1 bg-pink-400 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-pink-500 transition-all duration-300 transform hover:scale-105">カウンター (10%税)</button>
          <button onclick="selectMode('bar', this)" class="mode-btn flex-1 bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl shadow-md hover:bg-gray-400 transition-all duration-300 transform hover:scale-105">バー (税なし)</button>
        </div>
        <div id="modeDisplay" class="mt-4 text-center text-pink-600 font-semibold"></div>
      </div>
      
      <!-- Product List Card -->
      <div class="bg-white rounded-2xl shadow-lg p-5 mb-6">
        <h2 class="text-lg font-bold text-gray-700 mb-3">商品一覧 (タップして追加)</h2>
        <div id="productList" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
          <!-- Products will be loaded here -->
        </div>
      </div>

      <!-- Cart Card -->
      <div class="bg-white rounded-2xl shadow-lg p-5 mb-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-bold text-gray-700">🛒 カート</h3>
          <button onclick="resetCart()" class="text-sm bg-gray-200 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-300 transition-colors">リセット</button>
        </div>
        <ul id="cartList" class="divide-y divide-gray-200">
          <!-- Cart items will be loaded here -->
        </ul>
        <div id="cart-empty-msg" class="text-center text-gray-400 py-4">カートは空です</div>
        
        <!-- Totals -->
        <div class="mt-4 border-t pt-4 space-y-2 text-gray-600">
          <div class="flex justify-between"><span>税抜き金額</span><span class="font-medium"><span id="subtotal">0</span> 円</span></div>
          <div class="flex justify-between"><span>消費税</span><span class="font-medium"><span id="tax">0</span> 円</span></div>
          <div class="flex justify-between text-xl font-bold text-pink-600">
            <span>ご請求額</span>
            <span><span id="total">0</span> 円</span>
          </div>
        </div>
      </div>

      <!-- Page Switch Button -->
      <div class="text-center">
        <button onclick="switchPage()" class="w-full bg-green-400 text-white font-bold py-4 px-4 rounded-xl shadow-md hover:bg-green-500 transition-all duration-300 transform hover:scale-105">
          商品を登録・編集する
        </button>
      </div>
    </div>

    <!-- Page 2: Product Registration -->
    <div id="page2" class="hidden fade-in">
      <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-green-500">商品の登録と編集</h1>
      </header>

      <div class="bg-white rounded-2xl shadow-lg p-5 mb-6">
        <h2 class="text-lg font-bold text-gray-700 mb-3">新規商品登録</h2>
        <div class="space-y-4">
          <input type="text" id="nameInput" placeholder="商品名" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:outline-none transition">
          <input type="number" id="priceInput" placeholder="価格 (割引は-100のように入力)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:outline-none transition">
          <button onclick="addProduct()" class="w-full bg-green-400 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-green-500 transition-all duration-300 transform hover:scale-105">この内容で商品を登録</button>
        </div>
      </div>
      
      <div class="text-center mt-6">
        <button onclick="switchPage()" class="w-full bg-gray-400 text-white font-bold py-4 px-4 rounded-xl shadow-md hover:bg-gray-500 transition-all duration-300 transform hover:scale-105">
          レジに戻る
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Modal -->
  <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50 fade-in">
    <div id="modal-box" class="bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm w-full">
      <p id="modal-message" class="text-gray-700 mb-6"></p>
      <div id="modal-buttons" class="flex gap-3">
        <!-- Modal buttons go here -->
      </div>
    </div>
  </div>


  <script>
    let db;
    let cart = {};
    let selectedMode = 'counter'; // Default to counter

    const dbName = "ProductDB_v2";
    const storeName = "products";

    // --- Custom Modal Functions ---
    // Replaces default alert()
    function showAlert(message) {
      const overlay = document.getElementById('modal-overlay');
      const messageEl = document.getElementById('modal-message');
      const buttonsEl = document.getElementById('modal-buttons');

      messageEl.textContent = message;
      buttonsEl.innerHTML = `<button onclick="closeModal()" class="w-full bg-pink-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-pink-600 transition">OK</button>`;
      
      overlay.classList.remove('hidden');
    }

    // Replaces default confirm()
    function showConfirm(message, onConfirm) {
      const overlay = document.getElementById('modal-overlay');
      const messageEl = document.getElementById('modal-message');
      const buttonsEl = document.getElementById('modal-buttons');

      messageEl.textContent = message;
      buttonsEl.innerHTML = `
        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition">キャンセル</button>
        <button id="confirm-btn" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition">はい、削除します</button>
      `;
      
      document.getElementById('confirm-btn').onclick = () => {
        onConfirm();
        closeModal();
      };

      overlay.classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
    }


    // --- IndexedDB Functions ---
    function openDB(callback) {
      const request = indexedDB.open(dbName, 1);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(storeName)) {
          db.createObjectStore(storeName, { keyPath: 'name' });
        }
      };
      request.onsuccess = (event) => {
        db = event.target.result;
        callback();
      };
      request.onerror = () => showAlert("データベースの読み込みに失敗しました。");
    }

    // --- Product Management ---
    function addProduct() {
      const name = document.getElementById('nameInput').value.trim();
      const price = parseFloat(document.getElementById('priceInput').value);
      if (!name || isNaN(price)) {
        showAlert("正しい商品名と価格を入力してください。");
        return;
      }

      const tx = db.transaction(storeName, "readwrite");
      const store = tx.objectStore(storeName);
      store.put({ name, price });
      tx.oncomplete = () => {
        showAlert("商品を登録しました！");
        document.getElementById('nameInput').value = '';
        document.getElementById('priceInput').value = '';
        if (!document.getElementById('page2').classList.contains('hidden')) {
           loadProductsOnEditPage();
        }
      };
    }

    function loadProducts() {
      if (!db) return;
      const productList = document.getElementById('productList');
      productList.innerHTML = '';
      const tx = db.transaction(storeName, "readonly");
      const store = tx.objectStore(storeName);
      const request = store.getAll();

      request.onsuccess = () => {
        const products = request.result.sort((a,b) => a.name.localeCompare(b.name));
        products.forEach(product => {
          const button = document.createElement('button');
          button.className = `p-3 rounded-xl shadow text-center transition transform hover:scale-105 ${
            product.price >= 0 
            ? 'bg-pink-100 text-pink-800' 
            : 'bg-indigo-100 text-indigo-800'
          }`;
          button.innerHTML = `
            <div class="font-bold">${product.name}</div>
            <div class="text-sm">${product.price} 円</div>
          `;
          button.onclick = () => {
            const key = product.name;
            if (!cart[key]) cart[key] = { ...product, count: 0 };
            cart[key].count++;
            updateCart();
          };
          productList.appendChild(button);
        });
        
        // Also load products on the edit page if it's visible
        if (!document.getElementById('page2').classList.contains('hidden')) {
          loadProductsOnEditPage();
        }
      };
    }
    
    // To show products also on the registration page for editing
    function loadProductsOnEditPage() {
        // First clear existing list if any, except for the registration form
        const page2 = document.getElementById('page2');
        const existingLists = page2.querySelectorAll('.product-edit-list');
        existingLists.forEach(list => list.remove());

        const container = document.createElement('div');
        container.className = 'product-edit-list bg-white rounded-2xl shadow-lg p-5 mb-6';
        container.innerHTML = '<h2 class="text-lg font-bold text-gray-700 mb-3">登録済み商品 (クリックで削除)</h2>';
        
        const listDiv = document.createElement('div');
        listDiv.className = 'space-y-2';
        container.appendChild(listDiv);

        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = () => {
            const products = request.result.sort((a,b) => a.name.localeCompare(b.name));
            if (products.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-400 text-center">まだ商品がありません</p>';
            } else {
                products.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                    item.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${product.name}</span>
                            <span class="text-sm text-gray-500 ml-2">${product.price} 円</span>
                        </div>
                    `;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400 hover:text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    `;
                    deleteBtn.onclick = () => {
                        showConfirm(`「${product.name}」を本当に削除しますか？`, () => {
                            const delTx = db.transaction(storeName, "readwrite");
                            const delStore = delTx.objectStore(storeName);
                            delStore.delete(product.name);
                            delTx.oncomplete = () => {
                                showAlert('商品を削除しました。');
                                loadProductsOnEditPage(); // Refresh list on edit page
                                if (cart[product.name]) {
                                    delete cart[product.name];
                                    updateCart();
                                }
                            };
                        });
                    };
                    item.appendChild(deleteBtn);
                    listDiv.appendChild(item);
                });
            }
            page2.insertBefore(container, page2.children[1]);
        };
    }


    // --- Cart Management ---
    function updateCart() {
      const cartList = document.getElementById('cartList');
      const emptyMsg = document.getElementById('cart-empty-msg');
      cartList.innerHTML = '';
      let subtotal = 0;
      let discount = 0;

      const cartItems = Object.values(cart);

      if (cartItems.length === 0) {
        emptyMsg.classList.remove('hidden');
      } else {
        emptyMsg.classList.add('hidden');
        cartItems.forEach(item => {
          if (item.count <= 0) {
              delete cart[item.name];
              return;
          }
          const li = document.createElement('li');
          li.className = 'flex justify-between items-center py-3';
          li.innerHTML = `
            <div>
              <span class="font-semibold text-gray-800">${item.name}</span>
              <span class="text-sm text-gray-500 ml-2">(${item.price}円)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="font-medium">x ${item.count}</span>
              <button class="bg-gray-200 rounded-full w-7 h-7 flex items-center justify-center text-lg font-bold text-gray-600 hover:bg-gray-300">-</button>
            </div>
          `;
          li.querySelector('button').onclick = () => {
            item.count--;
            if (item.count <= 0) delete cart[item.name];
            updateCart();
          };
          cartList.appendChild(li);

          if (item.price >= 0) {
            subtotal += item.price * item.count;
          } else {
            discount += item.price * item.count;
          }
        });
      }

      const tax = (selectedMode === 'counter') ? Math.floor(subtotal * 0.1) : 0;
      const total = subtotal + tax + discount;

      document.getElementById('subtotal').textContent = subtotal;
      document.getElementById('tax').textContent = tax;
      document.getElementById('total').textContent = total;
    }

    function resetCart() {
      if (Object.keys(cart).length > 0) {
        cart = {};
        updateCart();
        showAlert("カートをリセットしました。");
      }
    }

    // --- Page & Mode Control ---
    function switchPage() {
      document.getElementById('page1').classList.toggle('hidden');
      document.getElementById('page2').classList.toggle('hidden');
      
      const isPage1Visible = !document.getElementById('page1').classList.contains('hidden');
      if (isPage1Visible) {
        loadProducts(); // Refresh main product list when returning to register
      } else {
        loadProductsOnEditPage(); // Load products for editing when switching to page 2
      }
    }

    function selectMode(mode, btnElement) {
      selectedMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('bg-pink-400', 'text-white');
        btn.classList.add('bg-gray-300', 'text-gray-700');
      });
      btnElement.classList.remove('bg-gray-300', 'text-gray-700');
      btnElement.classList.add('bg-pink-400', 'text-white');

      document.getElementById('modeDisplay').textContent =
        mode === 'counter' ? '現在の業態：カウンター（10%消費税）' : '現在の業態：バー（消費税なし）';
      updateCart();
    }
    
    // --- Initial Load ---
    window.onload = () => {
      openDB(() => {
        loadProducts();
        // Set default mode on load
        selectMode('counter', document.querySelector('.mode-btn'));
      });
      // PWA service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log("SW registered", reg))
          .catch(err => console.log("SW registration failed", err));
      }
    };
  </script>
</body>
</html>
